# Telegram-бот для записи клиентов (agent team)

## Что показываем

Три агента совместно создают Telegram-бота для салона красоты "Бархат". Бот позволяет клиентам выбрать услугу, мастера, время и записаться, а данные попадают в Google Sheets.

Суть демо: агенты координируются при работе с общими данными. Если один агент меняет структуру (например, формат записи в таблице), он сообщает об этом другим напрямую.

## Время выполнения

- **Claude (Opus 4.6):** 8-12 минут
- **GLM 4.7:** 12-18 минут (агенты медленнее согласовывают формат данных, иногда нужен повторный промпт)

## Роли агентов

**Агент 1 -- Разработчик бота.** Пишет Python-скрипт на aiogram. Кнопки выбора категории услуг, конкретная услуга, мастер, дата и время, подтверждение. Проверяет, что выбранный слот свободен.

**Агент 2 -- Интеграция с Google Sheets.** Создаёт таблицу с листами: "Записи" (дата, время, клиент, услуга, мастер, статус), "Расписание мастеров" (доступные слоты), "Услуги" (прайс). Пишет функции для чтения и записи через Google Sheets API (gspread).

**Агент 3 -- Документация.** Пишет README для конечного пользователя: как запустить бота, как получить токен BotFather, как подключить Google Sheets. Плюс инструкция для администратора салона: как добавить мастера, изменить расписание, посмотреть записи.

## Как запустить демо

Убедитесь, что agent teams включены:

```
claude config set --global enableAgentTeams true
```

Перейдите в папку с демо и запустите Claude Code:

```
cd sessions/05-agent-teams/demo/booking-bot
claude
```

Промпт для запуска:

```
Создай Telegram-бот для записи клиентов в салон красоты. Прочитай файл services.md — там все услуги, мастера, расписание и правила записи.

Распредели работу между агентами:
1. Первый агент пишет бота на Python (aiogram 3.x): меню с кнопками, выбор услуги, мастера и времени, подтверждение записи.
2. Второй агент настраивает Google Sheets: таблица с листами для записей, расписания мастеров и прайса. Функции чтения и записи через gspread.
3. Третий агент пишет документацию: README для запуска + инструкция администратора.

Агенты должны договориться о формате данных между ботом и таблицей.
```

## На что обратить внимание студентов

### 1. Согласование формата данных

Это центральный момент демо. Агент-разработчик и агент-интеграция должны договориться:
- Как хранить дату и время (ISO 8601? отдельные колонки?)
- Как идентифицировать мастера (имя? ID?)
- Как обозначать статус записи ("новая", "подтверждена", "отменена"?)

Обычно первый агент, который начнёт работу, предложит формат, а второй адаптируется. Иногда возникает конфликт, и это хороший момент для обсуждения.

### 2. Сообщения между агентами

Покажите, как в интерфейсе видно, что один агент пишет другому. Типичные ситуации:
- Агент 1 спрашивает агента 2: "В каком формате хранить telegram_user_id?"
- Агент 2 сообщает агенту 1: "Я изменил название колонки с 'Время' на 'Начало' и 'Конец'"
- Агент 3 спрашивает агента 1: "Какие переменные окружения нужны для запуска?"

### 3. Реакция на изменения

Если агент 2 решит поменять структуру таблицы (добавит колонку, переименует лист), он должен сообщить агенту 1. Покажите, как агент 1 обновляет свой код в ответ. В субагентной модели из занятия 4 такое невозможно: субагенты не общаются между собой.

### 4. Документация на основе реального кода

Агент 3 читает код, который пишут агенты 1 и 2, и на его основе пишет документацию. Если код меняется, документация обновляется. Агент 3 может спросить: "Вижу, что вы добавили обработку отмены. Нужно ли это описывать в инструкции администратора?"

## Ожидаемый результат

Агенты создадут следующие файлы:

- **`bot.py`** -- Telegram-бот на aiogram 3.x. Примерная структура:
  - `start_handler` -- приветствие и главное меню
  - `category_handler` -- выбор категории услуг (Стрижки, Окрашивание, Маникюр и т.д.)
  - `service_handler` -- выбор конкретной услуги с ценой и длительностью
  - `master_handler` -- выбор мастера (только те, кто оказывает эту услугу)
  - `datetime_handler` -- выбор даты и времени из свободных слотов
  - `confirm_handler` -- подтверждение записи, запись в Google Sheets
  - `cancel_handler` -- отмена записи
- **`sheets.py`** -- модуль для работы с Google Sheets:
  - `get_available_slots(master, date)` -- свободные слоты мастера на дату
  - `create_booking(data)` -- запись в лист "Записи"
  - `check_conflict(master, datetime, duration)` -- проверка пересечений
  - `get_services()` -- чтение прайса из листа "Услуги"
- **`requirements.txt`** -- зависимости (aiogram, gspread, oauth2client)
- **`README.md`** -- обновлённый, с инструкцией по запуску
- **`.env.example`** -- шаблон переменных окружения (BOT_TOKEN, GOOGLE_SHEETS_CREDENTIALS)
- **`admin_guide.md`** -- инструкция для администратора салона. Примерные разделы: "Как добавить нового мастера", "Как изменить расписание", "Как посмотреть записи на неделю"

Пример фрагмента из `admin_guide.md`, который может сгенерировать агент:

```
## Как добавить нового мастера

1. Откройте Google Sheets, лист "Расписание мастеров"
2. Добавьте строку: имя мастера, специализация (через запятую), рабочие дни
3. В листе "Услуги" проверьте, что услуги нового мастера есть в прайсе
4. Бот подхватит изменения автоматически — перезапуск не нужен
```

## Отличие от субагентов

На занятии 4 мы запускали субагентов, и каждый делал свою часть и возвращал результат "наверх". Здесь:
- Агенты работают параллельно и видят работу друг друга
- Агент может написать другому агенту напрямую
- Если возникает конфликт (оба меняют один файл, или один ломает формат данных другого), агенты решают его между собой
- Team lead распределяет задачи, но агенты сами координируются в процессе

## Разрешение конфликтов

### Два агента редактируют один файл

Типичная ситуация: агент 1 (бот) и агент 3 (документация) оба хотят обновить README.md. Team lead обычно назначает файл одному ответственному. Если конфликт всё-таки возник, один из агентов увидит, что файл изменился, и перечитает его перед записью. На практике это выглядит как короткая пауза и повторная попытка.

Что делать, если агенты застряли: добавьте в промпт явное распределение файлов. Например: "README.md пишет только агент 3. Агенты 1 и 2 передают ему информацию через сообщения."

### Агент выдаёт слабый результат

Бывает, что агент-документатор пишет общие фразы вместо конкретных инструкций, или агент-разработчик создаёт бота без обработки ошибок. Варианты:
- Дать фидбэк всей команде: "Документация слишком абстрактная. Добавьте конкретные команды и примеры."
- Попросить другого агента проверить: "Агент 1, посмотри документацию агента 3, всё ли там корректно?"
- Перезапустить одного агента с уточнённым промптом.

### Team lead назначил пересекающиеся задачи

Иногда team lead просит и агента 1, и агента 2 реализовать проверку конфликтов расписания. Оба начинают писать похожий код. Обычно агенты замечают это сами и один отступает. Если нет, уточните: "Проверку конфликтов пишет только агент 2 в sheets.py. Агент 1 вызывает его функцию."

## Фолбэки

**Агенты работают медленно (дольше 20 минут).** Проверьте, не застряли ли они в цикле согласования. Если два агента бесконечно обсуждают формат данных, вмешайтесь: "Используйте ISO 8601 для дат и имена мастеров как строки. Продолжайте." Если GLM 4.7 работает слишком медленно, покажите разницу на Claude Opus 4.6 с тем же промптом.

**Google Sheets API требует реальных credentials.** Для демо код будет написан, но без реального токена не заработает. Это нормально: цель -- показать процесс координации, а не работающего бота.

**Агент-документатор начинает раньше остальных.** Иногда агент 3 начинает писать документацию до того, как код готов. Он может написать заглушки и обновить позже, или подождать. Зависит от того, как team lead распределит зависимости.

**Агенты пишут в один файл одновременно.** Иногда два агента пытаются редактировать один файл. Team lead обычно разруливает это, назначая файлы ответственным. Если случилось, покажите, как это выглядит.
