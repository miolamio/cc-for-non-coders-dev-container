# Анализ 300 ответов NPS (agent team)

## Что показываем

Три агента разбирают CSV с 300 ответами клиентов из NPS-опроса. Каждый агент работает со своей частью анализа, но они обмениваются находками в процессе. Если агент, который анализирует тональность, обнаруживает аномалию (например, волну негатива по конкретной теме), он сразу пишет об этом агенту-аналитику.

## Время выполнения

- **Claude (Opus 4.6):** 8-12 минут
- **GLM 4.7:** 15-20 минут (300 строк -- ощутимый объём; GLM обрабатывает порциями, что занимает больше времени, но результат сопоставимый)

## Данные

Файл `nps-responses.csv` содержит 300 записей:
- `respondent_id` -- идентификатор респондента
- `score` -- оценка от 0 до 10
- `comment` -- комментарий на русском
- `date` -- дата ответа (ноябрь 2025 -- февраль 2026)
- `customer_segment` -- сегмент: enterprise, smb, individual

В данных заложены кластеры проблем:
- Медленная доставка (30+ упоминаний) -- задержки, потери, повреждения, проблемы с курьерами
- Плохая поддержка (30+ упоминаний) -- шаблонные ответы, долгое время реакции, закрытие тикетов без решения
- Хороший продукт, но слабый UX (10+ упоминаний) -- интерфейс, мобильное приложение, навигация
- Рост цен (10+ упоминаний) -- необоснованное повышение, непрозрачное ценообразование

Также есть положительные отзывы с конкретикой: интеграции, автоматизация, стабильность, конкретные сотрудники.

## Примеры ожидаемых категорий и меток тональности

Вот как должны выглядеть размеченные комментарии в промежуточных результатах агентов:

**Категоризация (агент 1):**

| respondent_id | Категории | Комментарий (начало) |
|---|---|---|
| R002 | доставка, сроки | "Доставка опять задержалась на 5 дней..." |
| R004 | поддержка, время ответа | "Поддержка не отвечает по 3 дня..." |
| R006 | UX, обучение | "Продукт хороший, но интерфейс запутанный..." |
| R007 | цены, повышение | "Подняли цены на 30% без предупреждения..." |
| R017 | автоматизация, рассылки (позитив) | "Автоматизация рассылок экономит нам 20 часов..." |

**Тональность (агент 2):**

| respondent_id | score | Тональность | Интенсивность |
|---|---|---|---|
| R002 | 3 | негативная | средняя |
| R004 | 1 | негативная | высокая |
| R005 | 10 | положительная | высокая |
| R011 | 5 | нейтральная | низкая |
| R087 | 1 | негативная | высокая (гнев) |

**Фрагмент итогового отчёта (агент 3):**

```
## Топ-5 проблем

1. Поддержка (30+ упоминаний, средняя оценка ~1.9)
   Типичная цитата: "Поддержка закрыла мой тикет как 'решённый',
   хотя проблема осталась" (R087, enterprise, оценка 1)

2. Доставка (30+ упоминаний, средняя оценка ~2.5)
   Типичная цитата: "Доставка по Москве — 7 дней. По Москве.
   Я живу в 5 км от склада." (R167, individual, оценка 3)
```

## Роли агентов

**Агент 1 -- Категоризация.** Читает все 300 комментариев и раскладывает по темам. Определяет 8-12 тематических кластеров, присваивает каждому комментарию одну или несколько тем. Считает частотность.

**Агент 2 -- Тональность.** Определяет эмоциональную окраску каждого комментария: положительная, отрицательная, нейтральная. Оценивает интенсивность (от "ну нормально" до "это кошмар"). Ищет аномалии: всплески негатива по датам или сегментам.

**Агент 3 -- Аналитик.** Собирает результаты работы первых двух агентов и формирует итоговый отчёт. Выделяет топ-5 проблем с цитатами, считает NPS по сегментам, строит рекомендации.

## Как запустить демо

```
cd sessions/05-agent-teams/demo/nps-analysis
claude
```

Промпт:

```
Проанализируй файл nps-responses.csv — это 300 ответов клиентов из NPS-опроса.

Работайте командой из трёх агентов:
1. Первый агент категоризирует комментарии по темам (доставка, поддержка, цены, UX, функционал и т.д.). Каждому комментарию — одна или несколько тем.
2. Второй агент определяет тональность: позитивная, негативная, нейтральная. Если находит аномалию (всплеск негатива по теме или дате) — сразу сообщает третьему агенту.
3. Третий агент собирает итоговый отчёт: NPS по сегментам, топ-5 проблем с цитатами, топ-3 сильные стороны, рекомендации.

Результат — файл nps-report.md с полным анализом.
```

## На что обратить внимание студентов

### 1. Агент тональности находит аномалию

Это ключевой момент демо. Агент 2, анализируя тональность, замечает, что в определённый период или в определённом сегменте негатив резко выше среднего. Он пишет агенту 3 (аналитику) напрямую: "Обрати внимание: среди enterprise-клиентов в декабре 6 комментариев с оценкой 0-2, все про поддержку. Похоже на системный сбой."

Покажите это сообщение в интерфейсе. Это то, ради чего agent teams нужны: агенты реагируют на данные в реальном времени и делятся находками, не дожидаясь финала.

### 2. Параллельная обработка

Агенты 1 и 2 могут работать одновременно -- один категоризирует, другой оценивает тональность. Они не зависят друг от друга. Агент 3 ждёт результаты обоих, но может начать готовить структуру отчёта (заголовки, формат, NPS-формулу) пока первые два работают.

### 3. Общий файл данных

Все три агента работают с одним CSV. Покажите, что ни один агент не модифицирует исходный файл: каждый создаёт свой промежуточный результат, а итоговый отчёт собирается из них.

### 4. Конкретные цитаты в отчёте

Агент 3 берёт из работы агента 1 (темы) и агента 2 (тональность) конкретные комментарии для цитирования в отчёте. Например: "Топ-1 проблема: поддержка (30+ упоминаний, средняя оценка 1.9). Типичная цитата: 'Поддержка закрыла мой тикет как решённый, хотя проблема осталась'."

## Ожидаемый результат

- `nps-report.md` -- итоговый отчёт:
  - Общий NPS и NPS по сегментам (enterprise / smb / individual)
  - Топ-5 проблем с количеством упоминаний, средней оценкой и цитатами
  - Топ-3 сильные стороны с цитатами
  - Динамика по месяцам
  - Рекомендации (конкретные действия, не абстрактные советы)
- Возможно промежуточные файлы от агентов (categories.csv, sentiment.csv)

## Отличие от субагентов

При работе субагентами (занятие 4) вы бы дали задачу "проанализируй NPS", и Claude запустил бы субагентов, каждый из которых вернул бы результат основному агенту. Здесь:
- Агент тональности может обнаружить закономерность и сообщить о ней аналитику до того, как закончит свою работу
- Агенты видят, что делают другие, и могут скорректировать свой подход
- Аналитик может попросить агента категоризации: "Раздели тему 'доставка' на 'сроки', 'повреждения' и 'потери', в ней слишком много разного"

## Разрешение конфликтов

### Агенты категоризации и тональности расходятся в оценке

Агент 1 отнёс комментарий "Работает, но мобильная версия сайта -- страдание" к категории "UX". Агент 2 пометил его как "негативный". Агент 3 при сборке отчёта видит: оценка 6 (пассив), но комментарий негативный по содержанию. Это нормальное расхождение. Агент 3 должен учитывать и числовую оценку, и текст. Если агенты спорят, аналитик решает.

### Агент категоризации создал слишком мало или слишком много категорий

Три широкие категории ("хорошо", "плохо", "нейтрально") бесполезны. 25 микрокатегорий -- тоже. Если агент 1 пошёл не туда, агент 3 просит пересмотреть: "Нужно 8-12 категорий. Объедини 'медленный ответ поддержки' и 'не решают проблему' в одну 'поддержка'. Раздели 'доставка' на 'сроки' и 'повреждения'."

### Два агента начинают писать итоговый отчёт

Иногда и агент 1, и агент 3 пытаются сформировать финальный nps-report.md. Уточните в промпте: "Итоговый отчёт пишет только агент 3. Агенты 1 и 2 сохраняют промежуточные результаты в отдельные файлы."

## Фолбэки

**Агент 3 начинает раньше, чем данные готовы.** Аналитик может попытаться написать отчёт до получения результатов. Team lead обычно выстраивает зависимости: агент 3 ждёт агентов 1 и 2. Если этого не произошло, покажите, как агент 3 пишет заготовку и дополняет по мере поступления данных.

**Категоризация слишком общая.** Агент 1 может создать 3-4 широкие категории вместо 8-12 детальных. Если так, покажите, как аналитик просит уточнить.

**Большой CSV и контекст.** 300 строк -- ощутимый объём. Агенты могут обрабатывать данные порциями. Это нормально и даже показательно: видно, как они распределяют нагрузку.

**GLM 4.7 обрабатывает CSV медленнее.** Если обработка 300 строк занимает больше 20 минут, можно обрезать CSV до 100 строк для демо и предупредить студентов, что полный файл обработается дольше.
