# Локальный тестовый экземпляр — один контейнер
#
# Запуск:  ./run.sh
# Или:     docker compose up --build
#
# Портал: http://localhost:8080  (пароль из .env)

services:
  student:
    build: .
    container_name: claude-course-test
    environment:
      - PASSWORD=${PASSWORD:-student-2026}
      - ANTHROPIC_AUTH_TOKEN=${GLM_API_KEY:-}
      - ANTHROPIC_BASE_URL=https://api.z.ai/api/anthropic
      - ANTHROPIC_DEFAULT_OPUS_MODEL=${GLM_OPUS_MODEL:-GLM-5}
      - ANTHROPIC_DEFAULT_SONNET_MODEL=${GLM_SONNET_MODEL:-GLM-5}
      - ANTHROPIC_DEFAULT_HAIKU_MODEL=${GLM_HAIKU_MODEL:-GLM-4.5-Air}
      - API_TIMEOUT_MS=${API_TIMEOUT_MS:-3000000}
      - ANTHROPIC_AUTH_TOKEN_BACKUP=${GLM_API_KEY_BACKUP:-}
    ports:
      - "8080:8080"
    volumes:
      - student-data:/home/coder/course
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 4G
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 5s
      retries: 3

volumes:
  student-data:
